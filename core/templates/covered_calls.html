{% extends "layouts/base.html" %}
{% load static %}
{% block title %} Summary {% endblock %}
<!-- Specific Plugin CSS goes HERE -->
{% block plugin_stylesheets %}{% endblock plugin_stylesheets %}
<!-- Specific CSS goes HERE -->
{% block stylesheets %}
<link rel="stylesheet" type="text/css" href="/static/assets/css/app.css">
{% endblock stylesheets %}
{% block content %}

<form action="/covered_calls/" method="POST">
  <div class="card">
    <div class="card-body">
      <h4 class="card-title">filters</h4>
      <table class="table table-bordered">
        <colgroup>
          <col class="large" />
          <col class="small" />
          <col class="small" />
          <col class="small" />
          <col class="small" />
          <col class="tiny" />
        </colgroup>
        <tbody>
          <tr>
            <th> tickers </th>
            <th> min_itm_pc </th>
            <th> max_itm_pc </th>
            <th> min_max_profit_pc </th>
            <th> max_days_to_exp </th>
          </tr>
          <tr>
            <td> <input id="tickers"           type="text"     name="tickers"           value="{{ tickers }}"> </td>
            <td> <input id="min_itm_pc"        type="text"     name="min_itm_pc"        value="{{ min_itm_pc }}"> </td>
            <td> <input id="max_itm_pc"        type="text"     name="max_itm_pc"        value="{{ max_itm_pc }}"> </td>
            <td> <input id="min_max_profit_pc" type="text"     name="min_max_profit_pc" value="{{ min_max_profit_pc }}"> </td>
            <td> <input id="max_days_to_exp"   type="text"     name="max_days_to_exp"   value="{{ max_days_to_exp }}"> </td>
            <th> <input type="submit" value="submit" name='submit'> </th>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  {% csrf_token %}
  <!-- {{ form }} -->
  <div class="content-wrapper">
    <div class="row stretch-card">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title">Line chart</h4>
          <div id="chartContainer" style="height: 500px; width: 100%;"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="content-wrapper">
    <div class="row">
      <div class="col-lg-12 grid-margin stretch-card">
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th> symbol </th>
                    <th> curr_price </th>
                    <th> call_price </th>
                    <th> strike </th>
                    <th> exp_date </th>
                    <th> effective_cost </th>
                    <th> max_profit </th>
                    <th> max_profit_pc </th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in table %}
                    <tr>
                      <td> {{ row.symbol }} </td>
                      <td> {{ row.curr_price | floatformat:2 }} </td>
                      <td> {{ row.call_price | floatformat:2 }} </td>
                      <td> {{ row.strike | floatformat:2 }} </td>
                      <td> {{ row.exp_date }} </td>
                      <td> {{ row.effective_cost | floatformat:2 }} </td>
                      <td> {{ row.max_profit | floatformat:2 }} </td>
                      <td> {{ row.max_profit_pc | floatformat:2 }} % </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>

{% endblock content %}
{% block plugin_javascripts %}
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
{% endblock plugin_javascripts %}
{% block javascripts %}
<script>
  window.onload = function () {
    var idx             = 0;
    var dte             = {{ dte            | safe }};
    var symbol          = {{ symbol         | safe }};
    var strike          = {{ strike         | safe }};
    var exp_date        = {{ exp_date       | safe }};
    var max_profit      = {{ max_profit     | safe }};
    var call_price      = {{ call_price     | safe }};
    var curr_price      = {{ curr_price     | safe }};
    var max_profit_pc   = {{ max_profit_pc  | safe }};
    var effective_cost  = {{ effective_cost | safe }};
    var scatter_data    = [{
                              type            : "scatter",
                              toolTipContent  : "sell {symbol} {strike}c {exp} at {premium}<br/>effective_cost: {effective_cost}<br/>max_profit %: {y}<br/>days to expiry: {x}",
                              dataPoints      : []
                            }];
    var chart = new CanvasJS.Chart("chartContainer",
                                   {
                                     title              : {text: "Max profit vs coverd call"},
                                     axisX              : {title:"days to expiry", tickLength: 1, tickColor: "red", tickThickness: 2},
                                     axisY              : {logarithmic: true, title: "Max profit percentage"},
                                     data               : scatter_data,
                                   }
                                  );
    for (idx = 0; idx < symbol.length; ++idx) {
      chart.options.data[0].dataPoints.push({
                                              x              : dte[idx],
                                              y              : max_profit_pc[idx],
                                              exp            : exp_date[idx],
                                              symbol         : symbol[idx],
                                              strike         : strike[idx],
                                              premium        : call_price[idx],
                                              stock_price    : curr_price[idx],
                                              effective_cost : effective_cost[idx],
                                            });
    }
    chart.render();
  }
</script>
{% endblock javascripts %}
